<!DOCTYPE html>
<html>
<head>
<script type='text/javascript'>
    var api = parent.pluginApi('cockpit-plugin');
    var config = api.configObject();

    // Customize API options that affect specific features of plugin API
    if (config.hasOwnProperty('allowedOrigins')) {
        api.options({
            // Configure source origin(s), i.e. protocol://domain:port
            // from which HTML5 message events will be accepted
            allowedMessageOrigins: config.allowedOrigins
        });
    }

    var COCKPIT_PORT = '9090';
    if (config.hasOwnProperty('cockpitPort')) {
        COCKPIT_PORT = config.cockpitPort;
    }

    api.register({
        UiInit : function() {
            // Add 'Web Console' sub-tab under 'Hosts' main-tab
            api.addSubTab('Host', 'Web Console', 'cockpit', '');

            // Add 'Web Console' button (+ context menu) to 'Hosts' main-tab
            api.addMainTabActionButton('Host', 'Web Console', {
                onClick : function() {
                    var win = window.open(getCockpitUrl(arguments[0]), '_blank');
                    win.focus();
                },
                isEnabled : function() {
                    // The button is enabled only when a single host is selected

                    // Starting ovirt-4.1, every host has Cockpit installed so check whether it's running is not needed.
                    return arguments.length == 1;
                }
            });

	    console.log('Cockpit UI Plugin initialized');
        },
        HostSelectionChange : function() {
	        console.log('Cockpit UI Plugin: host selection changed');
            if (arguments.length == 1) {
                // Update iframe URL
                api.setTabContentUrl('cockpit', getCockpitUrl(arguments[0]));
            } else {
                var cockpitUrl = (arguments.length > 0) ? 
                    (getCockpitUrl(arguments[0]) + '/ping') :
                    'https://[YOUR_HOST]:9090/ping';
                var url = 'plugin/cockpit-plugin/noCockpit.html?' + cockpitUrl;
                api.setTabContentUrl('cockpit', url);
            }
        },
    });

    // Get 'Cockpit' URL using specified host address
    var getCockpitUrl = function(selectedHost, protocol) {
        protocol = typeof protocol !== 'undefined' ? protocol : 'https';
        var hostAddress = selectedHost.hostname;
        var port = COCKPIT_PORT;
        var url = protocol + '://' + hostAddress + ':' + port;

        console.log('Cockpit URL: ' + url);
        return url;
    };

    api.ready();
</script>
</head>
<body>
</body>
</html>
